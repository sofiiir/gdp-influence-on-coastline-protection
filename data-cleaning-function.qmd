---
title: "data-cleaning-function"
format: html
---

```{r}
# load in appropriate libraries
library(DescTools)
library(tidyverse)
library(betareg)
```

## Address differences in names between gdp data and protected coastline data
```{r}
# use data from DescTools package to address 
country_names <- d.countries

# subset for only necessary columns
country_names <- country_names[, c('name', 'a3')]

country_names <- country_names |> 
   rename("iso_ter" = "a3")
```

Protected coastline data does not contain a year except for the mangrove data. For the purposes of this analysis, the assumption is that all of the data was last updated in 2016. 2016 GDP data will be used for consistency in the year. 
```{r}
# read in GDP data
gdp <- read_csv(here::here("data", "imf-dm-export-20251011.csv"))

# clean names for
gdp <-  janitor::clean_names(gdp)

# change column name to the same as the other dfs
gdp <- gdp |> 
   rename("name" = "gdp_per_capita_current_prices_u_s_dollars_per_capita")

# filter for only necessary 
gdp <- gdp[, c('name', 'x2016')]
```


```{r}
# read in coastline data
coastline <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "coastline_coverage.csv"))

# join with country names
coastline <- full_join(coastline, country_names, by = 'iso_ter')
```

```{r}
# Read in coldwater coral data
coldwater_coral <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "coldwatercorals.csv"))

coldwater_coral <- coldwater_coral |> 
   rename("iso_ter" = "ISO3")

# join with country names
coldwater_coral <- full_join(coldwater_coral, country_names, by = 'iso_ter')
```


```{r}
# Read in mangroves data
mangroves <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "mangroves.csv"))

mangroves <- mangroves |> 
   rename("iso_ter" = "ISO3")

# join with country names
mangroves <- full_join(mangroves, country_names, by = 'iso_ter')
```


```{r}
# read in salt marsh data
saltmarshes <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "saltmarshes.csv"))

saltmarshes <- saltmarshes |> 
   rename("iso_ter" = "ISO3")

# join with country names
saltmarshes <- full_join(saltmarshes, country_names, by = 'iso_ter')
```

```{r}
# Read in sea grass data
seagrasses <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "seagrasses.csv"))

seagrasses <- seagrasses |> 
   rename("iso_ter" = "ISO3")

# join with country names
seagrasses <- full_join(seagrasses, country_names, by = 'iso_ter')
```

```{r}
# read in warm water corals data
warm_coral <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "warmwatercorals.csv"))

warm_coral <- warm_coral |> 
   rename("iso_ter" = "ISO3") 

# join with country names
warm_coral <- full_join(warm_coral, country_names, by = 'iso_ter')
```

GENERALIZED FUNCTION 
```{r}

dfs <- c(coldwater_coral, mangroves, saltmarshes, seagrasses, warm_coral)
colors_list <- c("#773344", "forestgreen", "#273E47", "#9BC1BC", "#ED6A5A")

clean_data <- function(df, ecosystem, column_name, gdp){

  # join df and gdp data
  df_gdp <- full_join(df, gdp, by = 'name', relationship = "many-to-many")
  
  # filter out - and NA 
 df_gdp <- df_gdp |> 
  filter(({{column_name}} != "-"), ({{column_name}} != "NA") )
 
 # filter for countries with available GDP data for 2016.
 df_gdp <- df_gdp |> 
  filter(!is.na(x2016))
 
  # change the gdp data to numeric
  df_gdp <- transform(df_gdp, x2016 = as.numeric(x2016))

  # change percent protected to numeric
  df_gdp <- transform(df_gdp, percent_protected = as.numeric(percent_protected))
  
  # add a column with ecosystem type
  df_gdp <- df_gdp |> 
  mutate(ecosystem = ecosystem)
  
  return(df_gdp)
 
}

initial_graph <- function(df, ecosystem, color) {
  
   #initial plots
plot_df <- ggplot(data = df, aes(x = x2016, y = percent_protected )) +
  geom_point(color = color) +
  labs(x= "GDP",
       y = "Percent protected",
       title = print0("2016 Percent Protected", ecosystem)) +
  theme_classic()

return(plot_df)
}
```

```{r}
clean_coldwater_coral <- clean_data(df = coldwater_coral, ecosystem = 'coldwater_coral', column_name = total_area, gdp =  gdp)

# initial_graph(clean_coldwater_coral, ecosystem = "coldwater_coral", color = "#773344")

#initial plots
coldwater_coral_plot <- ggplot(data = clean_coldwater_coral, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#773344") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Coldwater Coral by GDP")) +
  theme_classic()

coldwater_coral_plot
```
```{r}
clean_coldwater_coral <- clean_coldwater_coral |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```


```{r}
clean_mangroves <- clean_data(df = mangroves, ecosystem = 'mangroves', column_name = total_area_2016, gdp = gdp)

#initial plots
mangrove_plot <- ggplot(data = clean_mangroves, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "forestgreen") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Mangroves by GDP")) +
  theme_classic()

mangrove_plot
```
```{r}
clean_mangroves <- clean_mangroves |> 
  rename("total_area" = "total_area_2016" )

clean_mangroves <- clean_mangroves |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```

```{r}
clean_saltmarshes <- clean_data(df = saltmarshes, ecosystem = 'saltmarshes', column_name = total_area, gdp =  gdp)

#initial plots
saltmarshes_plot <- ggplot(data = clean_saltmarshes, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#273E47") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Saltmarshes by GDP")) +
  theme_classic()

saltmarshes_plot
```
```{r}
clean_saltmarshes <- clean_saltmarshes |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```


```{r}
clean_seagrasses <- clean_data(df = seagrasses, ecosystem = "seagrasses", column_name = total_area, gdp =  gdp)

#initial plots
seagrass_plot <- ggplot(data = clean_seagrasses, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#9BC1BC") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Seagrasses by GDP")) +
  theme_classic()

seagrass_plot
```
```{r}
clean_seagrasses <- clean_seagrasses |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```

```{r}
clean_warm_coral <- clean_data(df = warm_coral, ecosystem = 'warm_coral', column_name = total_area, gdp =  gdp)

#initial plots
warm_coral_plot <- ggplot(data = clean_warm_coral, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#ED6A5A") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Warmwater Coral by GDP")) +
  theme_classic()

warm_coral_plot
```
```{r}
clean_warm_coral <- clean_warm_coral |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```


```{r}
rename_columns <- function (df) {
    df <- df |> rename("pc_gdp_2016" = "x2016",
         "country_name" = "name")
}
```

```{r}
clean_coldwater_coral <- rename_columns(clean_coldwater_coral)
clean_mangroves <- rename_columns(clean_mangroves)
clean_saltmarshes <- rename_columns(clean_saltmarshes)
clean_seagrasses <- rename_columns(clean_seagrasses)
clean_warm_coral <- rename_columns(clean_warm_coral)
```



Create one data frame
```{r}
coastal_ecosystem <- rbind(clean_coldwater_coral, clean_mangroves, clean_saltmarshes, clean_seagrasses, clean_warm_coral)
```
Rename column for clarity
```{r}
# coastal_ecosystem <- coastal_ecosystem |> 
#   rename("pc_gdp_2016" = "x2016",
#          "country_name" = "name",
#          "cumulative_area" = "total_area")
```

Change percent protected to proportion protected
```{r}
 coastal_ecosystem <- coastal_ecosystem |> 
  mutate( proportion_protected = (percent_protected /100))
```


```{r}
proportion_column <- function(df){
  df <- df |> 
  mutate( proportion_protected = (percent_protected /100))
  return(df)
}
```

```{r}
clean_coldwater_coral <- proportion_column(clean_coldwater_coral)
clean_mangroves <- proportion_column(clean_mangroves)
clean_saltmarshes <- proportion_column(clean_saltmarshes)
clean_seagrasses <- proportion_column(clean_seagrasses)
clean_warm_coral <- proportion_column(clean_warm_coral)
```



```{r}
# coastal_ecosystem <- coastal_ecosystem |> 
# mutate(proportion_protected = ifelse(proportion_protected == 0, proportion_protected + 0.000000000001, proportion_protected)) |> 
# mutate(proportion_protected = ifelse(proportion_protected == 1, proportion_protected - 0.000000000001, proportion_protected))

```

```{r}
zeros_and_ones <- function(y){
    n_obs <- sum(!is.na(y))
    (y * (n_obs - 1) + 0.5) / n_obs
}
```

```{r}
coastal_ecosystem <- coastal_ecosystem |> mutate(total_area = as.numeric(total_area))
```

# Beta Regression
```{r}
coastal_ecosystem_model <- betareg(zeros_and_ones(y = proportion_protected) ~ pc_gdp_2016 + total_area + ecosystem,
        data = coastal_ecosystem,
        link = "logit")

summary(coastal_ecosystem_model)
```

```{r}
coldwater_coral_model <- betareg(zeros_and_ones(y = proportion_protected) ~ pc_gdp_2016,
        data = clean_coldwater_coral,
        link = "logit")

summary(coldwater_coral_model)
```

```{r}
mangrove_model <- betareg(zeros_and_ones(y = proportion_protected) ~ pc_gdp_2016,
        data = clean_mangroves,
        link = "logit")

summary(mangrove_model)
```

```{r}
saltmarsh_model <- betareg(zeros_and_ones(y = proportion_protected) ~ pc_gdp_2016,
        data = clean_saltmarshes,
        link = "logit")

summary(saltmarsh_model)
```

```{r}
seagrass_model <- betareg(zeros_and_ones(y = proportion_protected) ~ pc_gdp_2016,
        data = clean_seagrasses,
        link = "logit")

summary(seagrass_model)
```


```{r}
warm_coral_model <- betareg(zeros_and_ones(y = proportion_protected) ~ pc_gdp_2016,
        data = clean_warm_coral,
        link = "logit")

summary(warm_coral_model)
```

