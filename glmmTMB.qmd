---
title: "clean-workflow"
format: 
  html: 
    code-fold: show
    embed-resources: true
execute: 
  echo: true
  message: false
  warning: false
  error: false
---

```{r}
#| output: false

# load in appropriate libraries
library(DescTools)
library(tidyverse)
library(patchwork)
library(betareg)
library(glmmTMB)
```

# Purpose
This repository investigates the hypothesis that nations with higher per capita GDP are more likely to protect their coastlines. 

# Data
The original data comes from the [Ocean+Habitats](https://habitats.oceanplus.org/) webpage which works to inform policy about the state of our oceans coastline focusing on metrics concerning ocean protection. This analysis focuses on the five ecosystems for which data is available. The five ecosystems are cold-water corals, mangroves, seagrasses, saltmarshes, and warm-water corals.

Per capita GDP data was acquired from the International Monetary Fund.

Data cleaning was performed in a separate file with the final product being a clean dataframe that contains only the appropriate variables for this analysis.

```{r}
#| ouput: false 

# read in clean data
coastal_ecosystem <- read_csv(here::here("gdp_coastal_ecosystem.csv"))
```

Initial plot of visualizing how GDP influences percent protected areas divided into ecosystems.
```{r}
ggplot(data = coastal_ecosystem, aes(x = pc_gdp_2016, 
                                     y = percent_protected, 
                                     color = ecosystem)) +
  geom_point() +
  scale_color_manual(values = c("#773344", 
                                "forestgreen", 
                                "#273E47", 
                                "#9BC1BC", 
                                "#ED6A5A"))+
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Areas by GDP")) +
  theme_classic()
```
Since our data is proportion data we will be using a Beta Regression model. 

Here is our proposed model based on our understanding of the variable interactions. 
$$
\begin{align}
\text{ProportionProtected} &\sim BetaRegression(\mu, \phi) \\
logit(\mu) &= \beta_0 + \beta_1 \text{GDP}+ \beta_2 \text{TotalArea}+ \beta_3 \text{Ecosystem}
\end{align}
$$

# Simulating data
We simulate data to make sure we understand the model before using the model on our real world data. To ensure we truly understand the model we want to simulate data that outputs similar values to those we use to calculate data. 

The model has three additive predictors. All of these predictors should have their own simulated values. For numeric predictors we can use the `runif` function to create a certain number of variable values within a given set of values. For categorical data we use the `rep` function that will create a list of the categorical values repeating through them until we get a list of the length we desire. 
```{r}
# assign values to our intercept and slope
beta0 <- 0.6
beta1 <- 1.9


# simulate the predictor data
# gdp <- seq(from = 433, to = 71000, by = 500)
# total_area <- seq(from = 0, to = 68100, by = 500)


gdp <- runif(1000, 0.433, 0.71)
total_area <- runif(1000, 0, 16)

ecosystem <- rep(c('coldwater_coral', 'mangrove', 'saltmarsh', 'seagrass', 'warmwater_coral'), length.out = 1000)

logit_mu <- beta0 + beta1 * gdp

phi <- 15 # this is shape1+shape2
mu <- 1 / (1 + exp(-logit_mu)) # this is shape1/(shape1+shape2)

shape1 <- mu * phi
shape2 <- phi - shape1

proportion_protected_sim <- rbeta(1000, shape1 = shape1, shape2 = shape2)

sim_df <- tibble(proportion_protected_sim, gdp , total_area, ecosystem)

sim_model <- glmmTMB(proportion_protected_sim ~ gdp + total_area + ecosystem,
  data = sim_df,
  family = beta_family(link = "logit"))

summary(sim_model)

```

# Data preparation

The Beta Regression model only works on proportion so here we change `percent_protected` to `proportion_protected`.
```{r}
 coastal_ecosystem <- coastal_ecosystem |> 
  mutate( proportion_protected = (percent_protected /100))
```

The Beta Regression model uses the link function logit. Logit does not work on 0's and 1's. We need to adjust the data to transform any 0's and 1's to slightly above 0 and slightly below 1. Here's a function created based on the vignette's description of how to handle these values. 
```{r}
zeros_and_ones <- function(y){
    n_obs <- sum(!is.na(y))
    (y * (n_obs - 1) + 0.5) / n_obs
}
```

Adjust the non-numeric values to numeric and apply the `zeros_and_ones` function to our proportion data.
```{r}
coastal_ecosystem <- coastal_ecosystem |> 
  mutate(total_area = as.numeric(total_area)) |> 
  mutate(adj_proportion_protected = zeros_and_ones(y = proportion_protected))
```

# Beta Regression
$$
\begin{align}
\text{ProportionProtected} &\sim BetaRegression(\mu, \phi) \\
logit(\mu) &= \beta_0 + \beta_1 \text{GDP}+ \beta_2 \text{TotalArea}+ \beta_3 \text{Ecosystem}
\end{align}
$$

## Fit a Beta Regression model. 
The Beta Regression model is useful when the response is a proportion. Since the protected areas is between 0 and 100 percent this model will assess whether there is any relationship between the predictors and the response. 
```{r}
coastal_ecosystem_model <- glmmTMB(adj_proportion_protected ~ pc_gdp_2016 + total_area + ecosystem,
  data = coastal_ecosystem,
  family = beta_family(link = "logit"))

sum_coastal_ecosystem_mod <- summary(coastal_ecosystem_model)
sum_coastal_ecosystem_mod
```


```{r}
# coastal_ecosystem_model <- betareg(adj_proportion_protected ~ pc_gdp_2016 + total_area + ecosystem,
#         data = coastal_ecosystem,
#         link = "logit")
# 
# summary(coastal_ecosystem_model)
```
```{r}
mean(coastal_ecosystem$pc_gdp_2016, na.rm = TRUE)
```


Now that we have run the Beta Regression let's create a best fit line. 

```{r}
pred_grid <- expand_grid(pc_gdp_2016 = seq(from = 433, to = 71000, by = 500)) |> 
  mutate(total_area = mean(coastal_ecosystem$total_area, na.rm = TRUE),
         ecosystem = 'coldwater_coral')
```

Run the model to predict expected protected proportion based when holding all variables constant but one. 
```{r}
pred <- pred_grid |> 
  mutate(predict =  predict(object = coastal_ecosystem_model,
                          newdata = pred_grid,
                          type = "response"))
```

Let's plot the predictions.
```{r}
ggplot(data = pred, aes(x = pc_gdp_2016, y = predict)) +
  geom_line()
```
WHAT DOES THIS MEAN?
As GDP increases the expected proportion of protected area increases marginally.





### Confidence Interval
Typically, we can use the predict function to calculate confidence intervals. Unfortunately, the Beta Regression models do not allow us to create confidence intervals using the predict function so we calculate these by hand below.
```{r}
#| eval: false

beta_model_se <- predict(object = coastal_ecosystem_model,
                          newdata = pred_grid,
                          type = "link", # stay in link space
                          se.fit = TRUE) #get the SE of the fit

```

The values from our summary model are utilized to create this data.
```{r}
beta0 <- sum_coastal_ecosystem_mod$coefficients$cond[1]
beta1 <- sum_coastal_ecosystem_mod$coefficients$cond[2]
beta2 <- sum_coastal_ecosystem_mod$coefficients$cond[3]
beta3_mangroves <- sum_coastal_ecosystem_mod$coefficients$cond[4]
beta3_saltmarsh <- sum_coastal_ecosystem_mod$coefficients$cond[5]
beta3_seagrass <- sum_coastal_ecosystem_mod$coefficients$cond[6]
beta3_warmwater_coral <- sum_coastal_ecosystem_mod$coefficients$cond[7]

se <- sum_coastal_ecosystem_mod$coefficients$cond[, "Std. Error"]
```

Confidence intervals are then calculated subtracting and adding one standard error from each beta value.
```{r}
# Beta 0 confidence intervals
beta0_CI_lwr <- beta0 - se[1]
beta0_CI_upr <- beta0 + se[1]

# Beta 1 confidence intervals
beta1_CI_lwr <- beta1 - se[2]
beta1_CI_lwr <- beta1 + se[2]

# Beta 2 confidence intervals
beta2_CI_lwr <- beta2 - se[3]
beta2_CI_lwr <- beta2 + se[3]

# Beta 3 mangrove confidence intervals
beta3_man_CI_lwr <- beta3_mangroves - se[4]
beta3_man_CI_lwr <- beta3_mangroves + se[4]

# Beta 3 saltmarsh confidence intervals
beta3_salt_CI_lwr <- beta3_saltmarsh - se[5]
beta3_salt_CI_lwr <- beta3_saltmarsh + se[5]

# Beta 3 seagrass confidence intervals
beta3_seag_CI_lwr <- beta3_seagrass - se[6]
beta3_seag_CI_lwr <- beta3_seagrass + se[6]

# Beta 3 confidence intervals
beta3_wwc_CI_lwr <- beta3_warmwater_coral - se[7]
beta3_wwc_CI_lwr <- beta3_warmwater_coral + se[7]

```


# References 

IMF. 2023. World Economic Outlook, October 2023. Washington, DC: International Monetary Fund. Â©IMF. https://doi.org/10.5089/9798400235801.081

UNEP-WCMC (2025). Ocean+ Habitats [On-line], [Downloaded: October 2025]. Available at: [habitats.oceanplus.org](habitats.oceanplus.org)

