---
title: "clean-workflow"
format: html
---

```{r}
#| output: false

# load in appropriate libraries
library(DescTools)
library(tidyverse)
library(patchwork)
library(betareg)
```

## Address differences in names between gdp data and protected coastline data
```{r}
#| output: false

# use data from DescTools package to address 
country_names <- d.countries

# subset for only necessary columns
country_names <- country_names[, c('name', 'a3')]

country_names <- country_names |> 
   rename("iso_ter" = "a3")
```

Protected coastline data does not contain a year except for the mangrove data. For the purposes of this analysis, the assumption is that all of the data was last updated in 2016. 2016 GDP data will be used for consistency in the year. 
```{r}
#| output: false

# read in GDP data
gdp <- read_csv(here::here("data", "imf-dm-export-20251011.csv"))

# clean names for
gdp <-  janitor::clean_names(gdp)

# change column name to the same as the other dfs
gdp <- gdp |> 
   rename("name" = "gdp_per_capita_current_prices_u_s_dollars_per_capita")

# filter for only necessary 
gdp <- gdp[, c('name', 'x2016')]
```


```{r}
#| output: false

# read in coastline data
coastline <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "coastline_coverage.csv"))

# join with country names
coastline <- full_join(coastline, country_names, by = 'iso_ter')
```

```{r}
#| output: false

# Read in coldwater coral data
coldwater_coral <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "coldwatercorals.csv"))

coldwater_coral <- coldwater_coral |> 
   rename("iso_ter" = "ISO3")

# join with country names
coldwater_coral <- full_join(coldwater_coral, country_names, by = 'iso_ter')
```

```{r}
#| output: false

# Read in mangroves data
mangroves <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "mangroves.csv"))

mangroves <- mangroves |> 
   rename("iso_ter" = "ISO3")

# join with country names
mangroves <- full_join(mangroves, country_names, by = 'iso_ter')
```

```{r}
# read in salt marsh data
saltmarshes <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "saltmarshes.csv"))

saltmarshes <- saltmarshes |> 
   rename("iso_ter" = "ISO3")

# join with country names
saltmarshes <- full_join(saltmarshes, country_names, by = 'iso_ter')
```

```{r}
# Read in sea grass data
seagrasses <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "seagrasses.csv"))

seagrasses <- seagrasses |> 
   rename("iso_ter" = "ISO3")

# join with country names
seagrasses <- full_join(seagrasses, country_names, by = 'iso_ter')
```

```{r}
# read in warm water corals data
warm_coral <- read_csv(here::here("data", "Ocean+HabitatsDownload_Global", "warmwatercorals.csv"))

warm_coral <- warm_coral |> 
   rename("iso_ter" = "ISO3") 

# join with country names
warm_coral <- full_join(warm_coral, country_names, by = 'iso_ter')
```


GENERALIZED FUNCTION 
```{r}

dfs <- c(coldwater_coral, mangroves, saltmarshes, seagrasses, warm_coral)
colors_list <- c("#773344", "forestgreen", "#273E47", "#9BC1BC", "#ED6A5A")

clean_data <- function(df, ecosystem, column_name, gdp){

  # join df and gdp data
  df_gdp <- full_join(df, gdp, by = 'name', relationship = "many-to-many")
  
  # filter out - and NA 
 df_gdp <- df_gdp |> 
  filter(({{column_name}} != "-"), ({{column_name}} != "NA") )
 
 # filter for countries with available GDP data for 2016.
 df_gdp <- df_gdp |> 
  filter(!is.na(x2016))
 
  # change the gdp and percent_protected data to numeric
  df_gdp <- df_gdp |> 
    mutate(x2016 = as.numeric(x2016)) |> 
    mutate(percent_protected = as.numeric(percent_protected))

  
  # add a column with ecosystem type
  df_gdp <- df_gdp |> 
  mutate(ecosystem = ecosystem)
  
  return(df_gdp)
 
}

initial_graph <- function(df, ecosystem, color) {
  
   #initial plots
plot_df <- ggplot(data = df, aes(x = x2016, y = percent_protected )) +
  geom_point(color = color) +
  labs(x= "GDP",
       y = "Percent protected",
       title = print0("2016 Percent Protected", ecosystem)) +
  theme_classic()

return(plot_df)
}
```

```{r}
clean_coldwater_coral <- clean_data(df = coldwater_coral, ecosystem = 'coldwater_coral', column_name = total_area, gdp =  gdp)

# initial_graph(clean_coldwater_coral, ecosystem = "coldwater_coral", color = "#773344")

#initial plots
coldwater_coral_plot <- ggplot(data = clean_coldwater_coral, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#773344") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Coldwater Coral by GDP")) +
  theme_classic()

coldwater_coral_plot
```

```{r}
clean_coldwater_coral <- clean_coldwater_coral |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```


```{r}
clean_mangroves <- clean_data(df = mangroves, ecosystem = 'mangroves', column_name = total_area_2016, gdp = gdp)

#initial plots
mangrove_plot <- ggplot(data = clean_mangroves, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "forestgreen") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Mangroves by GDP")) +
  theme_classic()

mangrove_plot
```

```{r}
clean_mangroves <- clean_mangroves |> 
  rename("total_area" = "total_area_2016" )

clean_mangroves <- clean_mangroves |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```

```{r}
clean_saltmarshes <- clean_data(df = saltmarshes, ecosystem = 'saltmarshes', column_name = total_area, gdp =  gdp)

#initial plots
saltmarshes_plot <- ggplot(data = clean_saltmarshes, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#273E47") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Saltmarshes by GDP")) +
  theme_classic()

saltmarshes_plot
```

```{r}
clean_saltmarshes <- clean_saltmarshes |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```


```{r}
clean_seagrasses <- clean_data(df = seagrasses, ecosystem = "seagrasses", column_name = total_area, gdp =  gdp)

#initial plots
seagrass_plot <- ggplot(data = clean_seagrasses, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#9BC1BC") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Seagrasses by GDP")) +
  theme_classic()

seagrass_plot
```

```{r}
clean_seagrasses <- clean_seagrasses |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```

```{r}
clean_warm_coral <- clean_data(df = warm_coral, ecosystem = 'warm_coral', column_name = total_area, gdp =  gdp)

#initial plots
warm_coral_plot <- ggplot(data = clean_warm_coral, aes(x = x2016, y = percent_protected )) +
  geom_point(color = "#ED6A5A") +
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Warmwater Coral by GDP")) +
  theme_classic()

warm_coral_plot
``` 


```{r}
clean_warm_coral <- clean_warm_coral |> select("iso_ter", "total_area", "protected_area", "percent_protected", "presence", "name", "x2016", "ecosystem")
```


```{r}
rename_columns <- function (df) {
    df <- df |> rename("pc_gdp_2016" = "x2016",
         "country" = "name")
}
```

```{r}
clean_coldwater_coral <- rename_columns(clean_coldwater_coral)
clean_mangroves <- rename_columns(clean_mangroves)
clean_saltmarshes <- rename_columns(clean_saltmarshes)
clean_seagrasses <- rename_columns(clean_seagrasses)
clean_warm_coral <- rename_columns(clean_warm_coral)
```


Create one data frame
```{r}
coastal_ecosystem <- rbind(clean_coldwater_coral, clean_mangroves, clean_saltmarshes, clean_seagrasses, clean_warm_coral)
```

Initial plot of the 
```{r}
ggplot(data = coastal_ecosystem, aes(x = pc_gdp_2016, 
                                     y = percent_protected, 
                                     color = ecosystem)) +
  geom_point() +
  scale_color_manual(values = c("#773344", 
                                "forestgreen", 
                                "#273E47", 
                                "#9BC1BC", 
                                "#ED6A5A"))+
  labs(x= "GDP",
       y = "Percent protected",
       title = print("2016 Percent Protected Areas by GDP")) +
  theme_classic()
```


The Beta Regression model only works on proportion so here we change `percent_protected` to `proportion_protected`.
```{r}
 coastal_ecosystem <- coastal_ecosystem |> 
  mutate( proportion_protected = (percent_protected /100))
```

The Beta Regression model uses the link function logit. Logit does not work on 0's and 1's. We need to adjust the data to transform any 0's and 1's to slightly above 0 and slightly below 1. Here's a function created based on the vignette's description of how to handle these values. 
```{r}
zeros_and_ones <- function(y){
    n_obs <- sum(!is.na(y))
    (y * (n_obs - 1) + 0.5) / n_obs
}
```

Adjust the non-numeric values to numeric and apply the `zeros_and_ones` function to our proportion data.
```{r}
coastal_ecosystem <- coastal_ecosystem |> 
  mutate(total_area = as.numeric(total_area)) |> 
  mutate(adj_proportion_protected = zeros_and_ones(y = proportion_protected))
```

# Beta Regression
$$
\begin{align}
\text{Proportion} &\sim BetaRegression(\mu, \phi) \\
logit(\mu) &= \beta_0 + \beta_1 \text{Predictor}
\end{align}
$$

Fit a Beta Regression model. The Beta Regression model is useful when the response is a proportion. Since the protected areas is between 0 and 100 percent this model will assess whether there is any relationship between the predictors and the response. 
```{r}
coastal_ecosystem_model <- betareg(adj_proportion_protected ~ pc_gdp_2016 + total_area + ecosystem,
        data = coastal_ecosystem,
        link = "logit")

summary(coastal_ecosystem_model)
```
```{r}
mean(coastal_ecosystem$pc_gdp_2016, na.rm = TRUE)
```


Now that we have run the Beta Regression let's create a best fit line. 

```{r}
pred_grid <- expand_grid(pc_gdp_2016 = seq(from = 0.01, to = 0.99, by = 0.01)) |> 
  mutate(total_area = mean(coastal_ecosystem$total_area, na.rm = TRUE),
         ecosystem = 'coldwater_coral')
```

Run the model to predict expected protected proportion based when holding all variables constant but one. 
```{r}
pred <- pred_grid |> 
  mutate(predict =  predict(object = coastal_ecosystem_model,
                          newdata = pred_grid,
                          type = "response"))
```

Let's plot the predictions.
```{r}
ggplot(data = pred, aes(x = pc_gdp_2016, y = predict)) +
  geom_line()
```
WHAT DOES THIS MEAN?
As GDP increases the expected proportion of protected area increases marginally.


```{r}
# beta_model_se <- predict.betareg(object = coastal_ecosystem_model,
#                           newdata = pred_grid,
#                           type = "link", # stay in link space
#                           se.fit = TRUE) #get the SE of the fit

```

```{r}
# slope <- -1.612e+00
# intercept <- 1.845e-05
# mean_gdp_2016 <- 14299.45
# logit_mu <- intercept + slope * mean_gdp_2016
# phi <- 1.0701                   # this is shape1+shape2
# mu <- 1 / (1 + exp(-logit_mu)) # this is shape1/(shape1+shape2)
# shape1 <- mu * phi
# shape2 <- phi - shape1

# proportion_protected_sim <- rbeta(100000, mu = 1, phi = 0.05)
```


```{r}
slope <- 250
intercept <- 4000
mean_gdp_2016 <- 14299.45
logit_mu <- intercept + slope * mean_gdp_2016
phi <- 0.0701                   # this is shape1+shape2
mu <- 1 / (1 + exp(-logit_mu)) # this is shape1/(shape1+shape2)
shape1 <- mu * phi
shape2 <- phi - shape1

# proportion_protected_sim <- rbeta(100000, mu = 1, phi = 0.05)
```





