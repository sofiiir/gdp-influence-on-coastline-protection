---
title: "clean-workflow"
author: "Sofia Rodas"
date: December 11, 2025
format: 
  html: 
    code-fold: show
    embed-resources: true
execute: 
  echo: true
  message: false
  warning: false
  error: false
---

```{r}
#| output: false
#| code-fold: true

# load in appropriate libraries
library(DescTools)
library(tidyverse)
library(patchwork)
library(glmmTMB)
library(kableExtra)

set.seed(12)
```

# Purpose
This repository investigates the hypothesis that nations with higher per capita GDP are more likely to protect their coastal ecosystems. This hypothesis is derived from the general knowledge that protecting ecosystems takes a large amount of resources. Policy must be put in place to create these protected areas. Countries with a higher per capita GDP would, in theory, have a greater amount of resources to spend on creating these zones. 

The type of ecosystem and the total area of a specific type of coastal ecosystem are also included in this analysis as they are confounding variables. The directed acyclic graph shows that the ecosystem type affects the proportion that is protected. Some ecosystems are more valuable for a nation monetarily if they are not protected. Additionally, depending on the type of protection of an ecosystem, officially protecting an area may be implausible as surrounding communities may be reliant on the ecosystem to make a living and/or eat. Total area is another confounding variable for proportion protected area as the more area a nation has of a specific ecosystem the less area they need to protect to achieve a higher percentage of proportion protected area. One example in which I would expect this to largely influence proportion protected area is in small island nations where they have a large area of coastal ecosystems. Even if they protect a greater area than another nation their proportion of protected area may be low. 



# Data
The original data comes from the [Ocean+Habitats](https://habitats.oceanplus.org/) webpage which works to inform policy about the state of our oceans coastline focusing on metrics concerning ocean protection. This analysis focuses on the five ecosystems for which data is available. The five ecosystems are cold-water corals, mangroves, seagrasses, saltmarshes, and warm-water corals.

Per capita GDP data was acquired from the International Monetary Fund.

Data cleaning was performed in a separate file with the final product being a clean dataframe that contains only the appropriate variables for this analysis.

```{r}
#| ouput: false 

# read in clean data
coastal_ecosystem <- read_csv(here::here("gdp_coastal_ecosystem.csv"))
```

Initial plot visualizing how per capita GDP influences percent protected areas differentiating between ecosystems.
```{r}
ggplot(data = coastal_ecosystem, aes(x = pc_gdp_2016, 
                                     y = percent_protected, 
                                     color = ecosystem)) +
  geom_point() +
  scale_color_manual(name = "Ecosystem",
                     values = c("#D51977", 
                                "forestgreen", 
                                "#273E47", 
                                "#9BC1BC", 
                                "#FEA82F"),
                     labels = c("Cold-water coral",
                                "Mangroves", 
                                "Salt marsh",
                                "Seagrass",
                                "Warm-water coral")) +
  labs(x= "Per Capita GDP ($USD)",
       y = "Percent protected",
       title = print("2016 Percent Protected Areas by GDP")) +
  theme_classic()
```
Since our data is proportion data we will be using a Beta Regression model. 

Here is our proposed model based on our understanding of the variable interactions. 
$$
\begin{align}
\text{ProportionProtected} &\sim BetaRegression(\mu, \phi) \\
logit(\mu) &= \beta_0 + \beta_1 \text{GDP}+ \beta_2 \text{TotalArea}+ \beta_3 \text{Mangroves} + \beta_4 \text{Saltmarshes}+ \beta_5 \text{Seagrass}+ \beta_6 \text{Warmwater Corals}
\end{align}
$$

# Simulating data
We simulate data to make sure we understand the model before using the model on our real world data. To ensure we truly understand the model we want to simulate data that outputs similar values to those we use to calculate data. 

We only simulate data for the per capita GDP variable as our hypothesis is that per capita GDP is positively influencing proportion protected area. Since per capita GDP is a numeric predictor we can use the `runif` function to create a certain number of variable values within a given set of values.
```{r}
# assign values to our intercept and slope
beta0 <- 0.6
beta1 <- 1.9

# simulate the predictor data
# gdp <- seq(from = 433, to = 71000, by = 500)

# simulate predictor values 
gdp <- runif(10000, 0.433, 0.71)

# linkspace equation
logit_mu <- beta0 + beta1 * gdp

# assign value to phi 
phi <- 15 # this is shape1+shape2

# calculate mu based on betas and simulated data 
mu <- 1 / (1 + exp(-logit_mu)) # this is shape1/(shape1+shape2)
```

To simulate values for the response variable we use `rbeta`. This requires the above parameters we have already assigned. According to the documentation, `shape1` and `shape2` are two variables that need to be calculated. 
```{r}
# calculate the paramerters for rbeta
shape1 <- mu * phi
shape2 <- phi - shape1

# simulate response data based on parameters assigned above 
proportion_protected_sim <- rbeta(10000, shape1 = shape1, shape2 = shape2)

# create a dataframe with the variables
sim_df <- tibble(proportion_protected_sim, gdp )

# simulate the model based on the simulated data 
sim_model <- glmmTMB(proportion_protected_sim ~ gdp,
  data = sim_df,
  family = beta_family(link = "logit"))

# make sure the values are close to the assigned variables
summary(sim_model)
```

The simulated model run on the simulated data outputs values close to the values we originally assigned to the variables. This is a sign we understand our model enough to move onto fitting the model on our own data!

# Data preparation

The Beta Regression model only works on proportion so here we change `percent_protected` to `proportion_protected`.
```{r}
 coastal_ecosystem <- coastal_ecosystem |> 
  mutate( proportion_protected = (percent_protected /100))
```

The Beta Regression model uses the link function `logit`. Logit does not work on 0's and 1's. We need to adjust the data to transform any 0's and 1's to slightly above 0 and slightly below 1. Here's a function created based on the vignette's description of how to handle these values. 
```{r}
zeros_and_ones <- function(y){
    n_obs <- sum(!is.na(y))
    (y * (n_obs - 1) + 0.5) / n_obs
}
```

Adjust the non-numeric values to numeric and apply the `zeros_and_ones` function to our proportion data.
```{r}
coastal_ecosystem <- coastal_ecosystem |> 
  mutate(total_area = as.numeric(total_area)) |> 
  mutate(adj_proportion_protected = zeros_and_ones(y = proportion_protected))
```

# Beta Regression
$$
\begin{align}
\text{ProportionProtected} &\sim BetaRegression(\mu, \phi) \\
logit(\mu) &= \beta_0 + \beta_1 \text{GDP}+ \beta_2 \text{TotalArea}+ \beta_3 \text{Mangroves} + \beta_4 \text{Saltmarshes}+ \beta_5 \text{Seagrass}+ \beta_6 \text{Warmwater Corals}
\end{align}
$$
## Hypothesis Statistical notation

$$
\begin{align}
H_0 &: \beta_1 > 0 \\
H_A &: \beta_1 !> 0
\end{align}
$$
The hypothesis as described in full detail in the introduction is that per capita GDP has a positive effect on the proportion of protected area. The null hypothesis is that per capita GDP does not have a positive effect on the proportion of protected area. 

## Fit a Beta Regression model. 
The Beta Regression model is useful when the response is a proportion. Since the protected areas is between 0 and 100 percent this model will assess whether there is any relationship between the predictors and the response. 
```{r}
coastal_ecosystem_model <- glmmTMB(adj_proportion_protected ~ pc_gdp_2016 + total_area + ecosystem,
  data = coastal_ecosystem,
  family = beta_family(link = "logit"))

sum_coastal_ecosystem_mod <- summary(coastal_ecosystem_model)
sum_coastal_ecosystem_mod
```


```{r}
mean(coastal_ecosystem$pc_gdp_2016, na.rm = TRUE)
```


Now that we ran the Beta Regression with the `glmmTMB` function let's create prediction lines based on ecosystem. We create data that shows the spread of the potential values for per capita GDP. Here we use `seq()` to create values from our lowest value to our highest value by a specific interval. We also want all of the ecosystems in the prediction grid. Every unique variation between the sequenced along per capita GDP values and different ecosystem type is included in the prediction grid. We keep the total area variable constant by using the mean since the values is numeric. 

```{r}

pred_grid <- expand_grid(pc_gdp_2016 = seq(from = 433, to = 71000, by = 500),
                            ecosystem = unique(coastal_ecosystem$ecosystem)) |> 
  mutate(total_area = mean(coastal_ecosystem$total_area, na.rm = TRUE))
```

Here we run the model to predict expected protected proportion based on the different combinations of possible per capita GDP and ecosystems holding total area constant. 

WHY CAN WE STAY IN "RESPONSE" SPACE?
```{r}
coastal_model_pred <- pred_grid |> 
  mutate(predict =  predict(object = coastal_ecosystem_model,
                          newdata = pred_grid,
                          type = "response")) 
```

Let's plot the predictions, differentiating by ecosystem. 
```{r}
ggplot(data = coastal_model_pred, aes(x = pc_gdp_2016, y = predict)) +
  geom_line(aes(color = ecosystem))+
  scale_color_manual(name = "Ecosystem",
                     values = c("#D51977", 
                                "forestgreen", 
                                "#273E47", 
                                "#9BC1BC", 
                                "#FEA82F"),
                     labels = c("Cold-water coral",
                                "Mangroves", 
                                "Salt marsh",
                                "Seagrass",
                                "Warm-water coral")) +
  labs(x= "Per Capita GDP ($USD)",
       y = "Percent protected",
       title = print("2016 Percent Protected Areas by GDP")) +
  theme_minimal()
```

#### What does this graph show?

The predictions are broken up by ecosystem. Across the board, all of the ecosystems are more likely to be protected the higher the per capita GDP is in a country. Saltmarshes are the most likely to be protected followed by mangroves, warm-water coral, and seagrass. Cold-water corrals are the least likely to be protected.

Overall, as GDP increases the expected proportion of protected areas increases, regardless of the ecosystem type.

### Confidence Interval
Typically, we can use the predict function to calculate confidence intervals. Unfortunately, the various  models that run beta regressions do not allow us to create confidence intervals using the predict function so we calculate these by hand below.
```{r}
#| eval: false

coastal_model_se <- predict(object = coastal_ecosystem_model,
                          newdata = pred_grid,
                          type = "link", # stay in link space
                          se.fit = TRUE,
                          component = "cond") # get the SE of the fit

```


# Confidence Intervals
### Prediction confidence intervals
#### Bootstrap

We can calculate the confidence intervals for predictions by constructing bootstraps. Bootstraps by definition are run on our original data. Samples are selected from the original data with replacement. Since we have 446 rows of data in our data frame, we can choose to select 446 samples in the boot per bootstrap calculated. Below we are running a bootstrap 1000 times. 

```{r}
boot <-  map_dfr(1:1000, \(i) {

  boot_sample <- slice_sample(coastal_ecosystem, n=446, replace = TRUE)
  
  boot_mod <- glmmTMB(adj_proportion_protected ~ pc_gdp_2016 + total_area + ecosystem,
                      family = beta_family(link = "logit"),
                      data = boot_sample)

    # add a prediction step
  mutate(pred_grid,
         adj_prop_protected = predict(object = boot_mod,
                          newdata = pred_grid,
                          type = "response"),
         boot = i)
})
```


```{r}
ggplot(boot, aes(x = pc_gdp_2016, y = adj_prop_protected)) +
  geom_line(aes(color = ecosystem)) +
    scale_color_manual(name = "Ecosystem",
                     values = c("#D51977", 
                                "forestgreen", 
                                "#273E47", 
                                "#9BC1BC", 
                                "#FEA82F"),
                     labels = c("Cold-water coral",
                                "Mangroves", 
                                "Salt marsh",
                                "Seagrass",
                                "Warm-water coral")) +
  labs(x= "Per Capita GDP ($USD)",
       y = "Percent protected",
       title = print("2016 Percent Protected Areas by GDP")) +
  theme_minimal()
```

Create a data frame from the bootstrapped values that contains the confidence intervals for each ecosystem at each per capita GDP value created for the prediction grid. 
```{r}
boot_ci <- boot |> group_by(pc_gdp_2016, ecosystem) |> 
  summarise(adj_prop_protected_lwr = quantile(adj_prop_protected, 0.025),
            adj_prop_protected_upr = quantile(adj_prop_protected, 0.975))
```

Plot the confidence intervals for the predictions differentiating for ecosystems. 
```{r}
#| code-fold: true

ggplot(coastal_model_pred, aes(x = pc_gdp_2016)) +
  geom_ribbon(data = boot_ci, 
              aes(ymin = adj_prop_protected_lwr, 
                         ymax = adj_prop_protected_upr, 
                         fill = ecosystem), 
              alpha = 0.2) +
  scale_color_manual(name = "Ecosystem",
                     values = c(coldwater_coral = "#D51977", 
                                mangroves = "forestgreen", 
                                saltmarshes = "#273E47", 
                                seagrasses = "#9BC1BC", 
                                warm_coral = "#FEA82F"),
                     labels = c("Cold-water coral",
                                "Mangroves", 
                                "Salt marsh",
                                "Seagrass",
                                "Warm-water coral")) +
  scale_fill_manual(name = "Ecosystem",
                     values = c(coldwater_coral = "#D51977", 
                               mangroves = "forestgreen", 
                                saltmarshes = "#273E47", 
                               seagrasses = "#9BC1BC", 
                                warm_coral = "#FEA82F"),
                     labels = c("Cold-water coral",
                                "Mangroves", 
                                "Salt marsh",
                                "Sea grass",
                                "Warm-water coral")) +
  geom_line(aes(color = ecosystem, y = predict)) +
  labs(x= "Per Capita GDP ($USD)",
       y = "Percent protected",
       title = print("2016 Percent Protected Areas by GDP")) +
  theme_minimal()
```
The confidence intervals on the predictions are showing the confidence intervals when all of the variables influences are accounted for in the computation. The confidence intervals for the mangrove, salt marsh, sea grass, and warm-water coral are all overlapping. This shows that the differences between the effect of 

On the other hand the confidence intervals of the individual predictors show the confidence interval only based on that one variable. 

The values from our summary model are utilized to create this data.
```{r}
#| code-fold: true

beta0 <- sum_coastal_ecosystem_mod$coefficients$cond[1]
beta1 <- sum_coastal_ecosystem_mod$coefficients$cond[2]
beta2 <- sum_coastal_ecosystem_mod$coefficients$cond[3]
beta3_mangroves <- sum_coastal_ecosystem_mod$coefficients$cond[4]
beta3_saltmarsh <- sum_coastal_ecosystem_mod$coefficients$cond[5]
beta3_seagrass <- sum_coastal_ecosystem_mod$coefficients$cond[6]
beta3_warmwater_coral <- sum_coastal_ecosystem_mod$coefficients$cond[7]

se <- sum_coastal_ecosystem_mod$coefficients$cond[, "Std. Error"]
```

Confidence intervals are then calculated subtracting and adding one standard error from each beta value.
```{r}
#| code-fold: true

# Beta 0 confidence intervals
beta0_CI_lwr <- beta0 - se[1]
beta0_CI_upr <- beta0 + se[1]

# Beta 1 confidence intervals
beta1_CI_lwr <- beta1 - se[2]
beta1_CI_upr <- beta1 + se[2]

# Beta 2 confidence intervals
beta2_CI_lwr <- beta2 - se[3]
beta2_CI_upr <- beta2 + se[3]

# Beta 3 mangrove confidence intervals
beta3_man_CI_lwr <- beta3_mangroves - se[4]
beta3_man_CI_upr <- beta3_mangroves + se[4]

# Beta 3 saltmarsh confidence intervals
beta3_salt_CI_lwr <- beta3_saltmarsh - se[5]
beta3_salt_CI_upr <- beta3_saltmarsh + se[5]

# Beta 3 seagrass confidence intervals
beta3_seag_CI_lwr <- beta3_seagrass - se[6]
beta3_seag_CI_upr <- beta3_seagrass + se[6]

# Beta 3 confidence intervals
beta3_wwc_CI_lwr <- beta3_warmwater_coral - se[7]
beta3_wwc_CI_upr <- beta3_warmwater_coral + se[7]

```

Create a dataframe with the confidence interval values.
```{r}
#| code-fold: true

CI_df <- tibble(
  Variable = c("Intercept", "GDP", "Total Area", "Mangroves", "Saltmarsh", "Seagrass", "Warm-water Coral"),
  BetaValues = c(beta0, beta1, beta2, beta3_mangroves, beta3_saltmarsh, beta3_seagrass, beta3_warmwater_coral),
  LowerCI = c(beta0_CI_lwr, beta1_CI_lwr, beta2_CI_lwr, beta3_man_CI_lwr, beta3_salt_CI_lwr, beta3_seag_CI_lwr, beta3_wwc_CI_lwr),
  UpperCI =c(beta0_CI_upr, beta1_CI_upr, beta2_CI_upr, beta3_man_CI_upr, beta3_salt_CI_upr, beta3_seag_CI_upr, beta3_wwc_CI_upr)
) 

CI_df |> 
  kable() |> 
  kable_styling()

```

## Hypothesis test 

We reject the null hypothesis that per capita GDP does not have a positive effect on the proportion of protected area for coastal ecosystems. The beta value for per capita GDP is low at `beta1`. This value makes sense since per capita GDP changes by the thousands. The p-value is less than 0.05 meaning that the liklihood that these findings are due to random chance are extremely low. The effect of per capita GDP on proportion protected area for coastal ecosystems is statistically significant. 


# References 

IMF. 2023. World Economic Outlook, October 2023. Washington, DC: International Monetary Fund. Â©IMF. https://doi.org/10.5089/9798400235801.081

UNEP-WCMC (2025). Ocean+ Habitats [On-line], [Downloaded: October 2025]. Available at: [habitats.oceanplus.org](habitats.oceanplus.org)

